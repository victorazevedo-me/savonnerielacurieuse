<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evenements</title>

    <style>
        table td {
            height: 5em;
            min-width: 10em;
            background-color: #ddd;
            padding: 0 1em;
        }

        table td.annule {
            border: 2px dashed red;
        }

        #prochain {
            display: flex;
        }

        #prochain .bloc {

            border: 1px solid #ccc;
            padding: 1em;
            margin: 1em;

        }

        #prochain .bloc * {
            margin: .5em 0;
        }
    </style>
</head>
<body>

    <div>
        <h3>Prochain evenements</h3>
        <div id="prochain">

        </div>
    </div>

    <table id="evenements">
        <thead>
            <tr>
                <td>Janvier</td>
                <td>Fevrier</td>
                <td>Mars</td>
                <td>Avril</td>
                <td>Mai</td>
                <td>Juin</td>
                <td>Juillet</td>
                <td>Aout</td>
                <td>Septembre</td>
                <td>Octobre</td>
                <td>Novembre</td>
                <td>Decembre</td>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
        

<script>

    //
    // DOIT ETRE SORTED
    // 

    const events = [{
            date: [[18, 04], [19, 04]],
            nom: "Ambert Côté Jardin",
            coord: "place Charles de Gaulles, Ambert 63600",
            cancelled: true
        },
        {
            date: [[02, 05], [03, 05]],
            nom: "Marché de producteurs",
            coord: "Vollore-Ville 63120",
            cancelled: true
        },
        {
            date: [[20, 06, 10], [20, 06, 18]],
            nom: "L'art dans tout ses états",
            coord: "place François Seguin, Maringues 63350",
            cancelled: true
        },
        {
            date: [["Les dimanches", 07, 9], ["Les dimanches", 07, 12]],
            nom: 'Marché de producteurs "Les Terroirs du pays d\'Olliergues"',
            coord: "place de la mairie, Olliergues 63880",
            cancelled: false
        },
        {
            date: [[14, 07]],
            nom: "Les concerts de Vollore et son marché de producteur",
            coord: "Vollore-Ville 63120",
            cancelled: true
        },
        {
            date: [[24, 07]],
            nom: "Marché de producteurs",
            coord: "Vollore-Ville 63120",
            cancelled: false
        },
        {
            date: [[25, 07], [26, 07]],
            nom: "Fêtes médiévales au château de la Faye",
            coord: "Olmet 63880",
            cancelled: true
        },
        {
            date: [["Les dimanches", 08]],
            nom: 'Marché de producteurs "Les Terroirs du pays d\'Olliergues"',
            coord: "place de la mairie, Olliergues 63880",
            cancelled: false
        },
        {
            date: [[20, 08]],
            nom: "Festival des insectes",
            coord: "La cité de l'abeille, Viscontat sur la terre 63250",
            cancelled: false
        },
        {
            date: [[15, 12]],
            nom: "Marché de noel",
            coord: "Escoutoux 63520",
            cancelled: false
        }]

    const marches = [{
        nom: "Billom",
        date: "un lundi sur deux",
        coord: "place de la Halle",
        note: "Temporairement Place Alfred Thomas"
    },{
        nom: "Montferrand",
        date: "1er samedi du mois",
        coord: "place de la Fontaine",
        note: ""
    },{
        nom: "Olliergues",
        date: "les dimanches matin, du 1er juillet au 26 août",
        coord: "place de la mairie",
        note: ""
    }]

    //
    // FONCTIONS
    //

    function calendrier() {

        let countArray = new Array(12).fill(0);

        function createTable(rows) {

            const tbody = document.getElementById('evenements').querySelector('tbody');

            for (let i = 0; i < rows; i++) {

                const row = document.createElement("tr");
                tbody.appendChild(row);

                for (let j = 0; j < countArray.length; j++) {
                    const col = document.createElement("td");
                    row.appendChild(col);
                }
            }
        }

        function addEventToTable(elem) {

            function dateControl(eventDate) {

                let mainDate = new Date(2020, mois)
                let string = ""

                //premier jour
                if (typeof(eventDate[0][0]) !== "string") {
                    mainDate.setDate(eventDate[0][0])
                    string = mainDate.toLocaleDateString("fr-FR", {weekday: "long", day: "numeric"})
                } else {
                    string = eventDate[0][0]
                }

                //deuxieme jour
                if (eventDate[1] && typeof(eventDate[1][0]) !== "string") {
                    mainDate.setDate(eventDate[1][0])
                    string += " & " + mainDate.toLocaleDateString("fr-FR", {weekday: "long", day: "numeric"})
                }

                //1ere heure
                if (eventDate[0][2]) {
                    string += `, ${eventDate[0][2]}h`
                }

                //2eme heure
                if (eventDate[1] && eventDate[1][2]) {
                    string += `- ${eventDate[1][2]}h`
                }

                return string
            }

            const tbody = document.getElementById('evenements').querySelector('tbody');
            const mois = elem.date[0][1] - 1
            let isFilled = false;
            let rowIndex = 0;   

            while (isFilled === false) {

                let tdtext = tbody.children[rowIndex].children[mois].innerText

                //cell is empty
                if (tdtext === "") {

                    //dom addition
                    const cell = tbody.children[rowIndex].children[mois]
                    const domDate = document.createElement("p")
                    const domNom = document.createElement("h4")
                    const domCoord = document.createElement("p")

                    domDate.innerText = dateControl(elem.date)
                    domNom.innerText = elem.nom
                    domCoord.innerText = elem.coord
                    
                    cell.appendChild(domDate)
                    cell.appendChild(domNom)
                    cell.appendChild(domCoord)


                    //cancelled
                    if (elem.cancelled) cell.className = "annule"

                    //stops loop
                    isFilled = true
                
                //if not, go to next row
                } else {
                    rowIndex += 1
                }
            }
        }   
    
        events.forEach((item, i) => {

        let mois = item.date[0][1]
        countArray[mois - 1] += 1

        })

        createTable(Math.max(...countArray))

        events.forEach(item => {
        addEventToTable(item)
        })
    }

    function prochaineRencontre() {

        function joursRestant(elem) {

            function decodeStringDate(date, string) {

                let jour = 0
                let joursDansMois = getDaysInMonth(d.getMonth() + 1)
                
                if (string === "Les dimanches") {
                    jour = 7

                    let ecart = jour - date.getDay()
                    ecart = (ecart > 0 ? 7 - ecart : ecart)

                    return ecart
                }
            }

            const getDaysInMonth = function(month) {
                return new Date(2020, month, 0).getDate();
            }

            let d = new Date()
            let ajdJour = d.getDate()
            let ajdMois = d.getMonth() + 1

            let eventMois = elem.date[0][1]
            let eventJour = elem.date[0][0]
            let response = ""

            //
            if (typeof(eventJour) === "string") {
                eventJour = decodeStringDate(d, eventJour)
            }

            if (elem.cancelled) {
                return false
            }

            //meme mois
            if (eventMois === ajdMois) {

                //jour superieur
                if (eventJour >= ajdJour) {
                    response = `dans ${eventJour - ajdJour} jours`
                }

                //meme jour
                else if (eventJour === ajdJour) {
                    response = `aujourd'hui`
                }
            }

            //un mois plus tard
            else if (eventMois - ajdMois === 1) {

                let calcul = 0

                if (eventJour < ajdJour) {
                    calcul = (getDaysInMonth(ajdMois) - ajdJour) + eventJour
                    response = `dans ${calcul} jours`
                } else {
                    calcul = eventJour - ajdJour
                    response = `dans 1 mois et ${calcul} jours`
                }
            }

            //plusieurs mois plus tard
            else if (eventMois - ajdMois > 1) {

                let diffMois = eventMois - ajdMois
                response = `dans ${diffMois} mois et ${eventJour} jours`
            }

            return response
        }

        events.forEach(elem => {

            const restant = joursRestant(elem)

            if (restant) {

                const domprochain = document.getElementById('prochain');
                const domWrap = document.createElement("div");
                const domTitre = document.createElement("h4");
                const domRestant = document.createElement("p");
                
                domTitre.innerText = elem.nom;
                domRestant.innerText = restant;

                domWrap.appendChild(domTitre);
                domWrap.appendChild(domRestant);
                domWrap.className = "bloc";

                domprochain.appendChild(domWrap);
            } 
        })
    }
    
    //
    // AU LANCEMENT
    //

    window.onload = function() {
        calendrier()
        prochaineRencontre()
    }

</script>
</body>
</html>